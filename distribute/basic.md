# DISTRIBUTION QUESTIONS

> 分布式事务的控制

分布式事务是指一个事务会涉及到到多个应用接口调用, 底层数据表涉及到多个, 但数据库可以是一个或多个, 它是传统单数据库事务在广度上的延伸.

事务并发控制, 在OLTP关系型数据库中, 事务并发控制往往是指事务的隔离性, 在本文中, 指的是应用层的并发事务控制, 常用的实现是乐观锁控制.

需要说明的是, 乐观锁解决的是事务并发控制, 它并不能解决分布式事务控制.

1. 接口内部实现本地事务, 接口之间不支持分布式事务, 然后辅以定期对账机制进行修正.
2. 目前的XA实现, 代码无侵入, 但对于并发和性能影响较大.
3. TCC实现, 代码有侵入, 改造难度较大, 但性能较好, 时效性很好
4. 基于消息, 引入了消息中间件, 方案较复杂.

> 分布式锁如何设计

一、zookeeper

1、实现原理：
基于zookeeper瞬时有序节点实现的分布式锁。大致思想即为：每个客户端对某个功能加锁时，在zookeeper上的与该功能对应的指定节点的目录下，生成一个唯一的瞬时有序节点。判断是否获取锁的方式很简单，只需要判断有序节点中序号最小的一个。当释放锁的时候，只需将这个瞬时节点删除即可。同时，其可以避免服务宕机导致的锁无法释放，而产生的死锁问题。

2、优点
锁安全性高，zk可持久化

3、缺点
性能开销比较高。因为其需要动态产生、销毁瞬时节点来实现锁功能。

4、实现
可以直接采用zookeeper第三方库curator即可方便地实现分布式锁。

二、memcached

1、实现原理：
memcached带有add函数，利用add函数的特性即可实现分布式锁。add和set的区别在于：如果多线程并发set，则每个set都会成功，但最后存储的值以最后的set的线程为准。而add的话则相反，add会添加第一个到达的值，并返回true，后续的添加则都会返回false。利用该点即可很轻松地实现分布式锁。

2、优点
并发高效。

3、缺点
（1）memcached采用列入LRU置换策略，所以如果内存不够，可能导致缓存中的锁信息丢失。
（2）memcached无法持久化，一旦重启，将导致信息丢失。

三、redis

redis分布式锁即可以结合zk分布式锁锁高度安全和memcached并发场景下效率很好的优点，可以利用jedis客户端实现。(setnx, setex)

> 分布式session如何设计

1. 基于数据库的Session共享
2. 基于NFS共享文件系统
3. 基于memcached 的session，如何保证 memcached 本身的高可用性？
4. 基于Redis 的 session 共享
5. 基于cookie 进行session共享

> dubbo的组件有哪些, 各有什么作用

Registry、Monitor、Provider、Consumer

> zookeeper的负载均衡算法有哪些

负载均衡算法

一般来说负载均衡设备都会默认支持多种负载均衡分发策略，例如：

Ø  轮询（RoundRobin）将请求顺序循环地发到每个服务器。当其中某个服务器发生故障，AX就把其从顺序循环队列中拿出，不参加下一次的轮询，直到其恢复正常。

Ø  比率（Ratio）：给每个服务器分配一个加权值为比例，根椐这个比例，把用户的请求分配到每个服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

Ø  优先权（Priority）：给所有服务器分组，给每个组定义优先权，将用户的请求分配给优先级最高的服务器组（在同一组内，采用预先设定的轮询或比率算法，分配用户的请求）；当最高优先级中所有服务器或者指定数量的服务器出现故障，AX将把请求送给次优先级的服务器组。这种方式，实际为用户提供一种热备份的方式。

Ø  最少连接数（LeastConnection）：AX会记录当前每台服务器或者服务端口上的连接数，新的连接将传递给连接数最少的服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

Ø  最快响应时间（Fast Response time）：新的连接传递给那些响应最快的服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

以上为通用的负载均衡算法，还有一些算法根据不同的需求也可能会用到，例如：

Ø  哈希算法( hash):  将客户端的源地址，端口进行哈希运算，根据运算的结果转发给一台服务器进行处理，当其中某个服务器发生故障，就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

Ø  基于策略的负载均衡：针对不同的数据流设置导向规则，用户可自行编辑流量分配策略，利用这些策略对通过的数据流实施导向控制。

Ø  基于数据包的内容分发：例如判断HTTP的URL，如果URL中带有.jpg的扩展名，就把数据包转发到指定的服务器。

> dubbo是如何利用接口就可以通信的
